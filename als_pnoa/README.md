# ALS PNOA Processing Component

Processes PNOA LiDAR tiles for training data preparation by selecting tiles that intersect with Sentinel-2 mosaics and standardizing their format and naming.

## Overview

This component takes raw PNOA (Plan Nacional de Ortofotografía Aérea) LiDAR vegetation height tiles and prepares them for machine learning training by:

1. **Spatial filtering**: Selecting only tiles that intersect with Sentinel-2 mosaics
2. **Temporal filtering**: Filtering by target years (2017-2021)
3. **Standardization**: Converting to consistent format and naming convention
4. **Deduplication**: Removing redundant tiles based on unique identifiers

## Structure

```
als_pnoa/
├── config.yaml                    # Component configuration
├── core/
│   └── pnoa_processor.py          # Main processing logic
├── scripts/
│   └── run_pnoa_processing.py     # Command-line script
└── README.md                      # This file
```

## Usage

### Basic Processing

```bash
# Process all configured years
python scripts/run_pnoa_processing.py

# Process specific years only
python scripts/run_pnoa_processing.py --years 2020 2021

# Custom output directory
python scripts/run_pnoa_processing.py --output-dir ./processed_pnoa
```

### Validation and Summary

```bash
# Validate inputs without processing
python scripts/run_pnoa_processing.py --validate-only

# Show processing summary
python scripts/run_pnoa_processing.py --summary
```

## Input Data Requirements

### 1. Sentinel-2 Mosaics
- **Location**: `data/processed/sentinel2_mosaics/`
- **Pattern**: `sentinel2_mosaic_{year}_*.tif`
- **Source**: Generated by `sentinel2_processing` component

### 2. PNOA Coverage Polygons
- **Location**: `data/raw/pnoa_coverage/Huso_{29,30,31}/`
- **Pattern**: `*.shp`
- **Content**: Polygon shapefiles with flight coverage areas and dates
- **Required fields**: `FECHA` (year), `PATH` (file path)

### 3. PNOA LiDAR Data
- **Location**: `data/raw/pnoa_lidar/PNOA2_LIDAR_VEGETATION/`
- **Pattern**: `NDSM-VEGETACION-*-COB2.tif`
- **Content**: Vegetation height tiles from PNOA LiDAR

## Output

### Processed Tiles
- **Location**: `data/processed/training_data_sentinel2_pnoa/`
- **Naming**: `PNOA_{year}_NDSM-VEGETACION-H{utm}-{tile_id}-COB2_epsg_25830.tif`
- **Format**: GeoTIFF with LZW compression
- **CRS**: EPSG:25830 (UTM Zone 30N)

### Example Output Files
```
PNOA_2021_NDSM-VEGETACION-H30-0177-COB2_epsg_25830.tif
PNOA_2020_NDSM-VEGETACION-H29-0234-COB2_epsg_25830.tif
PNOA_2019_NDSM-VEGETACION-H31-0156-COB2_epsg_25830.tif
```

## Processing Logic

1. **For each target year and Sentinel-2 tile**:
   - Read Sentinel-2 tile bounds
   - Find intersecting PNOA coverage polygons
   - Filter polygons by year (`FECHA` field)
   - Extract corresponding PNOA data file paths

2. **Deduplication**:
   - Extract unique tile identifiers from filenames
   - Keep only one file per unique identifier

3. **Standardization**:
   - Copy tiles to output directory
   - Apply standardized naming convention
   - Convert to float32 format with LZW compression

## Configuration

Key configuration sections in `config.yaml`:

- **`paths`**: Input and output directory locations
- **`processing`**: Target years, CRS, and file patterns
- **`output`**: Format specifications and naming templates
- **`validation`**: Quality control parameters

## Integration

This component integrates with:
- **Sentinel-2 Processing**: Uses summer mosaics as spatial reference
- **Canopy Height Model**: Provides training data for height prediction
- **Data Preparation Recipe**: Called during data preparation stage

## Data Sources

- **PNOA LiDAR**: Instituto Geográfico Nacional (IGN) - España
- **Coverage Information**: PNOA flight polygon metadata
- **License**: Open data under CC BY 4.0

## Performance Notes

- Processing time depends on number of intersecting tiles
- Typical processing: ~1000 tiles in 10-15 minutes
- Output size: ~50-100GB for complete coverage
- Memory usage: Low (processes one tile at a time)

## Troubleshooting

### Common Issues

**No intersecting tiles found**:
- Check Sentinel-2 mosaic coverage and naming
- Verify PNOA coverage polygon CRS compatibility

**Missing PNOA data files**:
- Ensure PNOA data directory contains NDSM-VEGETACION files
- Check file path references in coverage polygons

**UTM zone mismatches**:
- Verify UTM zone extraction from coverage filenames
- Check CRS settings in configuration

---

**Author**: Diego Bengochea  
**Component**: Part of the Iberian Carbon Assessment Pipeline